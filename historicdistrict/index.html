<!DOCTYPE html>

<html lang="en">

    <head>
    
        <meta charset="utf-8">
        
        <title>Building Age and Density in the Greenwich Village Historic District</title>
        
        <script type="text/javascript" src="d3/d3.v3.js"></script>
        <script src="http://d3js.org/queue.v1.min.js"></script>
        <script src="http://d3js.org/topojson.v1.min.js"></script>
        <link rel="stylesheet" type="text/css" href="styles.css">
        <link href='http://fonts.googleapis.com/css?family=News+Cycle:400,700' rel='stylesheet' type='text/css'>
<!--         <script src="scripts/modernizr.js"></script> -->
        
    </head>
        
    <body>
    	
    	<div id="selectorcontainer">
		
			<ul>
				
				<li><span>color:</span>
				<a href="Javascript: void(0);" id="y_const" class="notselected">year built</a> / <a href="Javascript: void(0);" id="num_floors" class="selected"># floors</a></li>
				
				<li><span>show:</span>
				<a href="Javascript: void(0);" id="after_hd" class="notselected">built since 1969</a> / <a href="Javascript: void(0);" id="all_b" class="selected">all</a></li>
			
			</ul>
		
		</div>		
		
<script type="text/javascript">

// Width and height
var w = 800 * 1.176470588; // ~816 | makes proportions consistent with shapefile
var h = 800; 

// Tooltip
var div = d3.select("body").append("div")   
            .attr("class", "tooltip")               
            .style("opacity", 0);

// Define map projection
var projection = d3.geo.conicConformal()
                       .rotate([74.0005585, 0])
                       .center([0,40.7344455])
                       .parallels([40.729015, 40.739876])
                       .scale(4600 * w)
                       .translate([w/2, h/2])
                       .precision(.1); 

// Define path generator
var path = d3.geo.path()
                 .projection(projection);

// Create SVG element
var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h); 

// Set variables for current view    		
var color_now = "floors"; // year 
var show_now = "all"; // since   

// 	Define Color ranges			
var color1 = d3.scale.ordinal()
               .domain([1, 2, 3, 4])
               .range(["rgb(26,150,65)", "rgb(166,217,106)", "rgb(253,174,97)", "rgb(215,25,28)"]); 

var colort1 = d3.scale.threshold()
                .domain([1700, 1900, 1940, 1970])
                .range(["rgb(247,247,247)", "#bcbddc", "#9e9ac8", "#756bb1", "#54278f"]);	

var colort2 = d3.scale.threshold()
                .domain([1980, 1990, 2000])
                .range(["#bcbddc", "#9e9ac8", "#756bb1", "#54278f"]);

// Define Legends   
// var legend_l1 = ["4 or fewer", "5 - 6", "7 - 9", "10 or more"]
// var legend_lt1 = ["N/A", "<1900", "1900-1939", "1940-1969", "1970+"]
// var legend_lt2 = ["1970s", "1980s", "1990s", "2000s"]	

d3.json("plutoclip.json", function(error, tp) {
    svg.selectAll(".clippedgeo")
       .data(topojson.feature(tp, tp.objects.clippedgeo).features)
       .enter()
       .append("path")
       .attr("d", path)
       .attr("stroke", "white")
       .attr("stroke-width", 0)
       .attr("fill", function(d) { 
            if (d.properties.HistDist != "Greenwich Village") { return "rgb(247,247,247)"; }
            else { return color1(d.properties.all); }
            })
       
       // Tooltip
       .on("mouseover", function(d) {
            d3.select(this).transition().duration(300).style("opacity", 0.5)
                           .style("stroke-width", 3 ) 
                           .style("color", "#000000");
            })
       .on("click", function(d) {
            d3.select(this).transition().duration(300).style("opacity", 0.5)
                           .style("stroke-width", 3 );
            div.transition().duration(300)
                .style("opacity", 1)
            div.html(
                     "<b>" + d.properties.Address + "</b>" + "<br>" + 
                     "<img src='" + 
                     "http://maps.googleapis.com/maps/api/streetview?size=150x150&location=?" + 
                     encodeURIComponent(d.properties.Address) + 
                     "%NYC&sensor=false&key=AIzaSyBoxwmXxAi2VdzMXqyrvEtgcqNh2r4hm0Q" + 
                     "'>" +
                     "<b>Year Built: </b>" + d.properties.YearBuilt + "<br>" + 
                     "<b>Number of Floors: </b>" + d.properties.NumFloors + "<br>" + 
                     "<b>Building Sq. Ft.: </b>" + d.properties.BldgArea + "<br>" + 
                     "<b># Residential Units: </b>" + d.properties.UnitsRes + "<br>" + 
                     "<b>Zoning: </b>" + d.properties.AllZoning1 + "<br>" 
//                      "Block: " + d.properties.Block + " | " + "Lot: " + d.properties.Lot + "<br>"  
                     )
                .style("left", (d3.event.pageX + 20) + "px")
                .style("top", (d3.event.pageY + 20) + "px");
            })
       .on("mouseout", function() {
            d3.select(this)
                .transition().duration(300)
                .style("opacity", 1)
                .style("stroke-width", 0 )
                ;
            div.transition().duration(300)
                .style("opacity", 0);
            })
        // End Tooltip
            
// street names

var sndata = [
{nm: "SEVENTH AVENUE", rot: 66, lon: -74.00190, lat: 40.735111},
{nm: "HUDSON STREET", rot: 84, lon: -74.006083, lat: 40.735144},
{nm: "FIFTH AVENUE", rot: 62, lon: -73.996141, lat: 40.732248},
{nm: "14TH STREET", rot: 333, lon: -73.995178, lat: 40.736642},
{nm: "BARROW STREET", rot: 353, lon: -74.007828, lat: 40.731651},
{nm: "SIXTH AVENUE", rot: 61, lon: -73.999288, lat: 40.733893}
];

var stnames = svg.selectAll("g.stnames")
                 .data(sndata)
                 .enter()
                 .append("g")
                 .attr("class", "stnames"); 
            
       stnames.append("text")
              .attr("x", function(d, i) { return ((-74.008927 - d.lon) / -0.016737) * w ; })
              .attr("y", function(d, i) { return (1-((40.729015 - d.lat) / -0.010861)) * h ; })
              .text(function(d, i) { return d.nm; })
              .attr("transform", function(d, i) { return "rotate(" + -d.rot + " " + ((-74.008927 - d.lon) / -0.016737) * w + "," + (1-((40.729015 - d.lat) / -0.010861)) * h + ")"; })
              .style("font-size", "10"); 
//         FIXES: use scales instead of manual transformations; move style to CSS

    // Legend
    
var dataleg_fa = [
    {lab: "< 4", len: 0.701009, col: "rgb(26,150,65)"},
    {lab: "5 - 6", len: 0.2501328, col: "rgb(166,217,106)"},
    {lab: "7 - 9", len: 0.0244291, col: "rgb(253,174,97)"},
    {lab: "10+", len: 0.0244291, col: "rgb(215,25,28)"}
    ];

var dataleg_fb = [
    {lab: "< 4", len: 0.620689655, col: "rgb(26,150,65)"},
    {lab: "5 - 6", len: 0.275862069, col: "rgb(166,217,106)"},
    {lab: "7 - 9", len: 0.068965517, col: "rgb(253,174,97)"},
    {lab: "10+", len: 0.034482759, col: "rgb(215,25,28)"}
    ];

var dataleg_ya = [
    {lab: "< 1900", len: 0.206024744, col: "#bcbddc"},
    {lab: "1900-39", len: 0.731038193, col: "#9e9ac8"},
    {lab: "1940-69", len: 0.047337278, col: "#756bb1"},
    {lab: "1970 +", len: 0.015599785, col: "#54278f"}
    ];

var dataleg_yb = [
    {lab: "1970s", len: 0.074074074, col: "#bcbddc"},
    {lab: "1980s", len: 0.666666667, col: "#9e9ac8"},
    {lab: "1990s", len: 0.148148148, col: "#756bb1"},
    {lab: "2000s", len: 0.111111111, col: "#54278f"}
    ];

// legend parameters
var l_width = 20; 
var offset_x = 700; 
var offset_y = 120; 

// legend scale
var scale = d3.scale.linear()
              .domain([0,1])
              .range([0, 250]);
    
var legend = svg.selectAll("g.legend")    
                .data(dataleg_fb)
                .enter()
                .append("g")
                .attr("class", "legend")
                .attr("transform", function(d, i) { return "translate(0," + i * l_width + ")"; }); 

    legend.append("rect")
          .attr("width", function(d) {return(scale(d.len));})
          .attr("height", l_width)
          .attr("x", offset_x)
          .attr("y", offset_y)
          .attr("fill", function(d) { return d.col; }); 
          
    legend.append("text")
          .attr("class", "leg_val")
          .attr("x", function(d) {return(scale(d.len) + 5 + offset_x);})
          .attr("y", offset_y)
          .attr("dy", "1em")
          .text(function(d){ return Math.round(d.len * 100) + "%"; }); 

    legend.append("text")
          .attr("class", "leg_lab")
          .attr("x", offset_x - 5)
          .attr("y", offset_y)
          .attr("dy", l_width * 0.8) // should match font percentage in CSS
          .text(function(d){ return d.lab; })
          .style("text-anchor", "end"); 
          
    svg.append("text")
          .attr("class", "leg_title")
          .attr("x", offset_x)
          .attr("y", offset_y - 25)
          .attr("dy", l_width)
          .text("% of buildings, by # floors");

    // End Legend

// Transitions

var dur = 500; // Transition duration

// legend transitions

var leg_trans = function (dsname, leg_title) {
        svg.selectAll("rect")    
		   .data(dsname)
		   .transition()
		   .duration(dur)
		   .attr("width", function(d) {return(scale(d.len));})
           .attr("fill", function(d) { return d.col; }); 

		svg.selectAll(".leg_val")    
		   .data(dsname)
		   .transition()
		   .duration(dur)
           .attr("x", function(d) {return(scale(d.len) + 5 + offset_x);})
           .text(function(d){ return Math.round(d.len * 100) + "%"; }); 

		svg.selectAll(".leg_lab")    
		   .data(dsname)
		   .transition()
		   .duration(dur)
           .text(function(d){ return d.lab; }); 

		svg.selectAll(".leg_title")    
		   .data(dsname)
		   .transition()
		   .duration(dur)
           .text(leg_title); 
}

// map fill transitions

var afterhd_floors = function() {
            svg.selectAll("path")
               .transition()
               .duration(dur)
               .attr("fill", function(d) {
                    if (d.properties.HistDist != "Greenwich Village") { return "#FFFFFF"; }
                    else if (d.properties.YearBuilt > 1969) { return color1(d.properties.all); }
                    else { return "rgb(247,247,247)"; }
                });}

var afterhd_year = function() {
            svg.selectAll("path")
               .transition()
               .duration(dur)
               .attr("fill", function(d) {
                    if (d.properties.HistDist != "Greenwich Village") { return "#FFFFFF"; }
                    else if (d.properties.YearBuilt > 1969) { return colort2(d.properties.YearBuilt); } 
                    else { return "rgb(247,247,247)"; }                   
                });}

var all_floors = function() {
            svg.selectAll("path")
               .transition()
               .duration(dur)
               .attr("fill", function(d) {
                    if (d.properties.HistDist != "Greenwich Village") { return "rgb(247,247,247)"; }
                    else { return color1(d.properties.all); } ;
                });}

var all_year = function() {
            svg.selectAll("path")
               .transition()
               .duration(dur)
               .attr("fill", function(d) {
                    if (d.properties.HistDist != "Greenwich Village") { return "rgb(247,247,247)"; }
                    else { return colort1(d.properties.YearBuilt); }                         
                });}

// Transition execution on click
// var color_now = "floors"; // year 
// var show_now = "all"; // since  

var title_bf = "% of buildings, by # floors";
var title_yb = "% of buildings, by year built";
                        
d3.select("#after_hd")
		.on("click", function(d) {
		    if (color_now == "floors") {
		        leg_trans(dataleg_fb, title_bf);
                afterhd_floors()
                }
            else {
		        leg_trans(dataleg_yb, title_yb);
                afterhd_year()            
            }
            d3.select("#all_b").attr("class", "notselected")
            d3.select(this).attr("class", "selected")
            show_now = "since"; 
		})
		
d3.select("#all_b")
		.on("click", function(d) {
		    if (color_now == "floors") {
		        leg_trans(dataleg_fa, title_bf);
                all_floors()
                }
            else {
		        leg_trans(dataleg_ya, title_yb);
                all_year()            
            }
            d3.select("#after_hd").attr("class", "notselected")
            d3.select(this).attr("class", "selected")
            show_now = "all"; 
		})

d3.select("#y_const")
		.on("click", function(d) {
		    if (show_now == "all") {
		        leg_trans(dataleg_ya, title_yb);
                all_year()
                }
            else {
		        leg_trans(dataleg_yb, title_yb);
                afterhd_year()            
            }
            d3.select("#num_floors").attr("class", "notselected")
            d3.select(this).attr("class", "selected")
            color_now = "year"; 
		})

d3.select("#num_floors")
		.on("click", function(d) {
		    if (show_now == "all") {
		        leg_trans(dataleg_fa, title_bf);
                all_floors()
                }
            else {
		        leg_trans(dataleg_fb, title_bf);
                afterhd_floors()            
            }
            d3.select("#y_const").attr("class", "notselected")
            d3.select(this).attr("class", "selected")
            color_now = "floors"; 
		})
		
		// End Transitions
    

    }) // End d3.json

</script>
				        
    </body>
    
</html>
